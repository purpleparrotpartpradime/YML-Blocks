<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ActionStack IDE</title>
    <link href="./tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 text-gray-200 p-4 overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">ActionStack Blocks</h2>
            <div id="block-list" class="space-y-2">
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="and">AND Gate</div>
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="xor">XOR Gate</div>
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="else">ELSE Gate</div>
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="nor">NOR Gate</div>
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="either">EITHER Gate</div>
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="math">Math</div>
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="variable">Variable</div>
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="calc-method">Calc Method</div>
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="html">Custom HTML</div>
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="java">Custom Java</div>
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="nodejs">Custom Node.js</div>
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="js">Custom JavaScript</div>
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="yml">Custom YAML</div>
            </div>
            <div id="html-block-list" class="space-y-2 hidden">
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="div">Div</div>
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="p">Paragraph</div>
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="button">Button</div>
                <div class="block-type p-2 bg-gray-700 rounded cursor-pointer" draggable="true" data-type="input">Input</div>
            </div>
        </div>
        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Toolbar -->
            <div class="bg-gray-700 p-2 flex space-x-2">
                <button id="export-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Export</button>
                <button id="import-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Import</button>
                <button id="save-btn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Save to GitHub</button>
                <input id="pat-input" type="password" placeholder="GitHub PAT" class="px-2 py-1 bg-gray-600 text-white rounded border border-gray-500">
            </div>
            <!-- Tabs -->
            <div class="flex border-b border-gray-600">
                <button id="yaml-tab" class="px-4 py-2 bg-gray-800 border-t border-l border-r border-gray-600 text-white">YAML Editor</button>
                <button id="html-tab" class="px-4 py-2 bg-gray-700 text-gray-400">HTML Editor</button>
            </div>
            <!-- Tab Content -->
            <div id="yaml-editor" class="flex-1 relative">
                <div id="yaml-tabs" class="flex border-b bg-gray-700 p-1">
                    <button class="new-tab px-2 py-1 bg-gray-800 rounded-t text-white">+ New YAML</button>
                </div>
                <canvas id="canvas" class="w-full h-full bg-gray-900"></canvas>
            </div>
            <div id="html-editor" class="flex-1 hidden p-4 bg-gray-900">
                <div id="html-elements" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let blocks = [];
        let wires = [];
        let tabs = [{ name: 'main.yml', blocks: [], wires: [] }];
        let currentTab = 0;
        let draggingBlock = null;
        let draggingWire = null;
        let htmlElements = [];
        let githubPAT = '';
        let isDragging = false;
        let isHtmlTab = false;

        // Block types configuration
        const blockTypes = {
            and: { color: '#2563EB', inputs: 2, outputs: 1, evaluate: (inputs) => inputs.every(i => i) },
            xor: { color: '#1E40AF', inputs: 2, outputs: 1, evaluate: (inputs) => inputs.filter(i => i).length === 1 },
            else: { color: '#3B82F6', inputs: 1, outputs: 1, evaluate: (inputs) => !inputs[0] },
            nor: { color: '#4B5563', inputs: 2, outputs: 1, evaluate: (inputs) => !inputs.some(i => i) },
            either: { color: '#1F2937', inputs: 2, outputs: 1, evaluate: (inputs) => inputs.filter(i => i).length === 1 },
            math: { 
                color: '#374151', 
                inputs: 2, 
                outputs: 1, 
                evaluate: (inputs, block) => {
                    const method = block.method || 'add';
                    const [a, b] = inputs.map(Number);
                    return {
                        add: a + b,
                        subtract: a - b,
                        multiply: a * b,
                        divide: b !== 0 ? a / b : 0
                    }[method];
                }
            },
            variable: { color: '#6B7280', inputs: 1, outputs: 1, evaluate: (inputs) => inputs[0] },
            'calc-method': { color: '#9CA3AF', inputs: 0, outputs: 1, evaluate: () => null },
            html: { color: '#1E3A8A', inputs: 0, outputs: 0, evaluate: () => null },
            java: { color: '#111827', inputs: 0, outputs: 0, evaluate: () => null },
            nodejs: { color: '#4B5563', inputs: 0, outputs: 0, evaluate: () => null },
            js: { color: '#2563EB', inputs: 0, outputs: 0, evaluate: () => null },
            yml: { color: '#3B82F6', inputs: 0, outputs: 0, evaluate: () => null }
        };

        // Resize canvas
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            draw();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Drag and drop blocks
        document.querySelectorAll('.block-type').forEach(btn => {
            btn.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', btn.dataset.type);
            });
        });

        canvas.addEventListener('dragover', (e) => e.preventDefault());
        canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            if (isHtmlTab) return; // Prevent block drops in HTML tab
            const type = e.dataTransfer.getData('text/plain');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const block = {
                id: Date.now(),
                type,
                x: x - 60, // Center block on drop
                y: y - 40,
                width: 120,
                height: 80,
                inputs: blockTypes[type].inputs,
                outputs: blockTypes[type].outputs,
                value: type === 'variable' ? 0 : null,
                method: type === 'calc-method' ? 'add' : null,
                code: ['html', 'java', 'nodejs', 'js', 'yml'].includes(type) ? '' : null,
                element: type === 'html' ? '' : null
            };
            tabs[currentTab].blocks.push(block);
            draw();
        });

        // Block dragging and wire connecting
        canvas.addEventListener('mousedown', (e) => {
            if (isHtmlTab) return; // Disable in HTML tab
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Check for block dragging
            draggingBlock = tabs[currentTab].blocks.find(b => 
                x >= b.x && x <= b.x + b.width && y >= b.y && y <= b.y + b.height
            );
            if (draggingBlock) {
                isDragging = true;
                return;
            }

            // Check for wire dragging
            tabs[currentTab].blocks.forEach(b => {
                for (let i = 0; i < b.outputs; i++) {
                    const ox = b.x + b.width + 10;
                    const oy = b.y + 20 + i * 20;
                    if (Math.hypot(x - ox, y - oy) < 8) {
                        draggingWire = { fromBlock: b.id, fromOutput: i, toBlock: null, toInput: null };
                    }
                }
            });
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isHtmlTab) return; // Disable in HTML tab
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (draggingBlock) {
                draggingBlock.x = x - draggingBlock.width / 2;
                draggingBlock.y = y - draggingBlock.height / 2;
                draw();
            } else if (draggingWire) {
                draw();
                ctx.beginPath();
                ctx.strokeStyle = '#9CA3AF';
                const fromBlock = tabs[currentTab].blocks.find(b => b.id === draggingWire.fromBlock);
                ctx.moveTo(fromBlock.x + fromBlock.width + 10, fromBlock.y + 20 + draggingWire.fromOutput * 20);
                ctx.lineTo(x, y);
                ctx.stroke();
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (isHtmlTab) return; // Disable in HTML tab
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (draggingWire) {
                tabs[currentTab].blocks.forEach(b => {
                    for (let i = 0; i < b.inputs; i++) {
                        const ix = b.x - 10;
                        const iy = b.y + 20 + i * 20;
                        if (Math.hypot(x - ix, y - iy) < 8) {
                            draggingWire.toBlock = b.id;
                            draggingWire.toInput = i;
                            tabs[currentTab].wires.push({ ...draggingWire });
                        }
                    }
                });
                draggingWire = null;
            }
            draggingBlock = null;
            isDragging = false;
            draw();
        });

        // Block interaction
        canvas.addEventListener('click', (e) => {
            if (isHtmlTab) return; // Disable in HTML tab
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const block = tabs[currentTab].blocks.find(b => 
                x >= b.x && x <= b.x + b.width && y >= b.y && y <= b.y + b.height
            );
            if (block) {
                if (block.type === 'variable') {
                    const value = prompt('Enter variable value:', block.value);
                    if (value !== null) block.value = parseFloat(value) || 0;
                } else if (block.type === 'calc-method') {
                    const method = prompt('Enter method (add/subtract/multiply/divide):', block.method);
                    if (method) block.method = ['add', 'subtract', 'multiply', 'divide'].includes(method) ? method : 'add';
                } else if (['html', 'java', 'nodejs', 'js', 'yml'].includes(block.type)) {
                    const code = prompt('Enter custom code:', block.code || '');
                    if (code !== null) block.code = code;
                } else if (block.type === 'html' && htmlElements.length > 0) {
                    const element = prompt('Select HTML element ID:', block.element || '');
                    if (element && htmlElements.find(el => el.id === element)) block.element = element;
                }
                draw();
            }
        });

        // Drawing
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (isHtmlTab) return; // Skip drawing in HTML tab
            tabs[currentTab].blocks.forEach(block => {
                // Draw block
                ctx.fillStyle = blockTypes[block.type].color;
                ctx.fillRect(block.x, block.y, block.width, block.height);
                ctx.strokeStyle = '#000000';
                ctx.strokeRect(block.x, block.y, block.width, block.height);
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '12px sans-serif';
                ctx.fillText(block.type.toUpperCase(), block.x + 10, block.y + 20);
                if (block.type === 'variable') ctx.fillText(`Value: ${block.value}`, block.x + 10, block.y + 40);
                if (block.type === 'calc-method') ctx.fillText(`Method: ${block.method}`, block.x + 10, block.y + 40);
                if (block.element) ctx.fillText(`Element: ${block.element}`, block.x + 10, block.y + 60);
                if (block.code) ctx.fillText(`Code: ${block.code.substring(0, 10)}${block.code.length > 10 ? '...' : ''}`, block.x + 10, block.y + 60);

                // Draw input nodes
                for (let i = 0; i < block.inputs; i++) {
                    ctx.beginPath();
                    ctx.arc(block.x - 10, block.y + 20 + i * 20, 6, 0, Math.PI * 2);
                    ctx.fillStyle = '#D1D5DB';
                    ctx.fill();
                    ctx.strokeStyle = '#000000';
                    ctx.stroke();
                }

                // Draw output nodes
                for (let i = 0; i < block.outputs; i++) {
                    ctx.beginPath();
                    ctx.arc(block.x + block.width + 10, block.y + 20 + i * 20, 6, 0, Math.PI * 2);
                    ctx.fillStyle = '#D1D5DB';
                    ctx.fill();
                    ctx.strokeStyle = '#000000';
                    ctx.stroke();
                }
            });

            // Draw wires
            ctx.strokeStyle = '#9CA3AF';
            ctx.lineWidth = 2;
            tabs[currentTab].wires.forEach(wire => {
                const fromBlock = tabs[currentTab].blocks.find(b => b.id === wire.fromBlock);
                const toBlock = tabs[currentTab].blocks.find(b => b.id === wire.toBlock);
                if (fromBlock && toBlock) {
                    ctx.beginPath();
                    ctx.moveTo(fromBlock.x + fromBlock.width + 10, fromBlock.y + 20 + wire.fromOutput * 20);
                    ctx.lineTo(toBlock.x - 10, toBlock.y + 20 + wire.toInput * 20);
                    ctx.stroke();
                }
            });
        }

        // Tab management
        document.querySelector('.new-tab').addEventListener('click', () => {
            const name = prompt('Enter YAML file name:', `file${tabs.length + 1}.yml`);
            if (name) {
                tabs.push({ name, blocks: [], wires: [] });
                updateTabs();
            }
        });

        function updateTabs() {
            const yamlTabs = document.getElementById('yaml-tabs');
            yamlTabs.innerHTML = '<button class="new-tab px-2 py-1 bg-gray-800 rounded-t text-white">+ New YAML</button>';
            tabs.forEach((tab, index) => {
                const btn = document.createElement('button');
                btn.className = `px-2 py-1 ${index === currentTab ? 'bg-gray-800' : 'bg-gray-700'} rounded-t text-white`;
                btn.textContent = tab.name;
                btn.addEventListener('click', () => {
                    currentTab = index;
                    updateTabs();
                    draw();
                });
                yamlTabs.insertBefore(btn, yamlTabs.firstChild);
            });
            document.querySelector('.new-tab').addEventListener('click', () => {
                const name = prompt('Enter YAML file name:', `file${tabs.length + 1}.yml`);
                if (name) {
                    tabs.push({ name, blocks: [], wires: [] });
                    updateTabs();
                }
            });
        }

        // HTML Editor
        document.getElementById('html-tab').addEventListener('click', () => {
            isHtmlTab = true;
            document.getElementById('yaml-editor').classList.add('hidden');
            document.getElementById('html-editor').classList.remove('hidden');
            document.getElementById('yaml-tab').classList.remove('bg-gray-800');
            document.getElementById('yaml-tab').classList.add('bg-gray-700');
            document.getElementById('yaml-tab').classList.add('text-gray-400');
            document.getElementById('html-tab').classList.add('bg-gray-800');
            document.getElementById('html-tab').classList.remove('bg-gray-700');
            document.getElementById('html-tab').classList.add('text-white');
            document.getElementById('block-list').classList.add('hidden');
            document.getElementById('html-block-list').classList.remove('hidden');
            updateHtmlEditor();
        });

        document.getElementById('yaml-tab').addEventListener('click', () => {
            isHtmlTab = false;
            document.getElementById('html-editor').classList.add('hidden');
            document.getElementById('yaml-editor').classList.remove('hidden');
            document.getElementById('html-tab').classList.remove('bg-gray-800');
            document.getElementById('html-tab').classList.add('bg-gray-700');
            document.getElementById('html-tab').classList.add('text-gray-400');
            document.getElementById('yaml-tab').classList.add('bg-gray-800');
            document.getElementById('yaml-tab').classList.remove('bg-gray-700');
            document.getElementById('yaml-tab').classList.add('text-white');
            document.getElementById('html-block-list').classList.add('hidden');
            document.getElementById('block-list').classList.remove('hidden');
            draw();
        });

        // HTML elements
        function addHtmlElement(type) {
            const id = `html-${Date.now()}`;
            htmlElements.push({ id, type: type || prompt('Enter HTML element type (div, p, button, etc.):'), content: '' });
            updateHtmlEditor();
        }

        function updateHtmlEditor() {
            const container = document.getElementById('html-elements');
            container.innerHTML = '<button class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700" onclick="addHtmlElement()">Add HTML Element</button>';
            htmlElements.forEach(el => {
                const div = document.createElement('div');
                div.className = 'p-2 bg-gray-800 rounded shadow';
                div.innerHTML = `
                    <strong class="text-blue-400">${el.type}</strong> (ID: ${el.id})
                    <input type="text" value="${el.content}" onchange="updateHtmlContent('${el.id}', this.value)" class="w-full p-1 bg-gray-700 text-white border border-gray-600 rounded">
                `;
                container.appendChild(div);
            });
        }

        window.addHtmlElement = addHtmlElement;
        window.updateHtmlContent = (id, content) => {
            const el = htmlElements.find(e => e.id === id);
            if (el) el.content = content;
        };

        // HTML drag and drop
        document.querySelectorAll('#html-block-list .block-type').forEach(btn => {
            btn.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', btn.dataset.type);
            });
        });

        document.getElementById('html-editor').addEventListener('dragover', (e) => e.preventDefault());
        document.getElementById('html-editor').addEventListener('drop', (e) => {
            e.preventDefault();
            if (!isHtmlTab) return;
            const type = e.dataTransfer.getData('text/plain');
            addHtmlElement(type);
        });

        // Export workspace
        document.getElementById('export-btn').addEventListener('click', () => {
            const workspace = { tabs, htmlElements };
            const blob = new Blob([JSON.stringify(workspace)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'actionstack-workspace.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Import workspace
        document.getElementById('import-btn').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const workspace = JSON.parse(event.target.result);
                    tabs = workspace.tabs;
                    htmlElements = workspace.htmlElements;
                    currentTab = 0;
                    updateTabs();
                    updateHtmlEditor();
                    draw();
                };
                reader.readAsText(file);
            };
            input.click();
        });

        // Save to GitHub
        document.getElementById('save-btn').addEventListener('click', async () => {
            githubPAT = document.getElementById('pat-input').value;
            if (!githubPAT) {
                alert('Please enter a GitHub Personal Access Token');
                return;
            }

            const repo = prompt('Enter GitHub repository (owner/repo):');
            if (!repo) return;

            // Generate YAML files
            const files = {};
            tabs.forEach(tab => {
                const yamlContent = generateYaml(tab);
                files[`.github/workflows/${tab.name}`] = btoa(yamlContent);
            });

            // Generate HTML file
            let htmlContent = '<!DOCTYPE html>\n<html>\n<head>\n<title>Generated Page</title>\n</head>\n<body>\n';
            htmlElements.forEach(el => {
                htmlContent += `<${el.type} id="${el.id}">${el.content}</${el.type}>\n`;
            });
            htmlContent += '</body>\n</html>';
            files['index.html'] = btoa(htmlContent);

            // Generate custom code files
            tabs.forEach(tab => {
                tab.blocks.forEach(block => {
                    if (block.code && ['java', 'nodejs', 'js'].includes(block.type)) {
                        const ext = { java: 'java', nodejs: 'js', js: 'js' }[block.type];
                        files[`src/${block.id}.${ext}`] = btoa(block.code);
                    }
                });
            });

            // Commit to GitHub
            try {
                const [owner, repoName] = repo.split('/');
                const response = await fetch(`https://api.github.com/repos/${owner}/${repoName}/contents/`, {
                    method: 'GET',
                    headers: { Authorization: `token ${githubPAT}` }
                });
                const data = await response.json();
                const sha = data.find(f => f.path === 'index.html')?.sha;

                for (const [path, content] of Object.entries(files)) {
                    await fetch(`https://api.github.com/repos/${owner}/${repoName}/contents/${path}`, {
                        method: 'PUT',
                        headers: { Authorization: `token ${githubPAT}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: 'Update from ActionStack IDE',
                            content,
                            sha: path === 'index.html' && sha ? sha : undefined
                        })
                    });
                }

                // Create secrets if needed
                const secretsResponse = await fetch(`https://api.github.com/repos/${owner}/${repoName}/actions/secrets`, {
                    headers: { Authorization: `token ${githubPAT}` }
                });
                const secrets = await secretsResponse.json();
                if (!secrets.secrets.some(s => s.name === 'ACTIONSTACK_PAT')) {
                    await fetch(`https://api.github.com/repos/${owner}/${repoName}/actions/secrets/ACTIONSTACK_PAT`, {
                        method: 'PUT',
                        headers: { Authorization: `token ${githubPAT}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ encrypted_value: btoa(githubPAT) })
                    });
                }

                window.open(`https://github.com/${repo}`, '_blank');
            } catch (error) {
                alert('Error saving to GitHub: ' + error.message);
            } finally {
                githubPAT = '';
                document.getElementById('pat-input').value = '';
            }
        });

        function generateYaml(tab) {
            const yamlObj = { name: tab.name.split('.')[0], on: { push: { branches: ['main'] } }, jobs: {} };
            const job = { steps: [] };
            tab.blocks.forEach(block => {
                if (['html', 'java', 'nodejs', 'js', 'yml'].includes(block.type)) {
                    job.steps.push({
                        name: `Run ${block.type} block ${block.id}`,
                        run: block.code
                    });
                }
            });
            yamlObj.jobs[job.steps.length ? 'build' : 'empty'] = job;
            return jsyaml.dump(yamlObj);
        }

        // Initialize
        updateTabs();
        draw();
    </script>
</body>
</html>
